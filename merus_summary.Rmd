---
title: "merus length vs carapace width"
author: "Katie Palof"
date: "March 21, 2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
options(scipen=999)
library(xlsx)
library(extrafont)
library(pwr)
loadfonts(device="win")
windowsFonts(Times=windowsFont("TT Times New Roman"))

theme_set(theme_bw(base_size=12,base_family='Times New Roman')+ 
            theme(panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank()))

dat <- read.xlsx("./data/Donaldson Blackburn 1989 Data.xlsx", sheetName = "rinput")
```

## Linear relationship between carapace width and raw merus length


```{r linear, echo = FALSE}
ggplot(dat, aes(width, raw_merus)) + 
         geom_point(size =2) +
         geom_smooth(method =lm)

fit1 = lm(raw_merus ~ width, data = dat) 
summary(fit1)
#plot(fit1)
```

## Confidence and Prediction intervals

```{r intervals, echo=FALSE}
# confidence interval -----
new.dat <- data.frame(width = seq(from =135, to = 215, length.out = 181))
conf_inter <- predict(fit1, newdata = new.dat, interval = 'confidence')
conf_inter <- as.data.frame(conf_inter)

conf_inter %>% 
  bind_cols(new.dat) ->confidenceI

# prediction interval ------
pred_inter <- predict(fit1, newdata = new.dat, interval = 'prediction')
pred_inter <- as.data.frame(pred_inter)

pred_inter %>% 
  bind_cols(new.dat) ->predictionI


# visual of confidence and predictive intervals -----
ggplot(dat, aes(width, raw_merus)) +
        geom_point(size =2, pch = 1) +
        geom_line(data = confidenceI, aes(width, fit), color = "black", size = 1) +
        geom_line(data = confidenceI, aes(width, lwr), color = "red", lty = 2, size = 1) +
        geom_line(data = confidenceI, aes(width, upr), color = "red", lty =2, size = 1) +
        geom_line(data = predictionI, aes(width, lwr), color = "blue", lty = 3, size = 1) +
        geom_line(data = predictionI, aes(width, upr), color = "blue", lty =3, size = 1) +
  xlab("carapace width (mm)") + ylab("merus length (mm)") + ggtitle("carapace width vs raw merus length") +
  geom_vline( xintercept = 177.8)
```


Footnote: black line is linear regression, red lines are confidence intervals and blue dashed lines are the prediction intervals

\newline


## Goal: sample size needed to reduce variability in the regression line and therefore decrease the 95% prediction interval 

Not sure if this is possible.  Suggestion would be to sample more intensely in area where there is overlap (see rectangle in figure below).  
The carapace width range in this box is:
```{r rectangle, echo= FALSE}
dat %>% 
  filter(raw_merus >124 & legal =="N") %>% 
  summarise(min = min(width))

dat %>% 
  filter(legal == "Y" & raw_merus <144) %>% 
  summarise(max = max(width))
```

``` {r sample area, echo=FALSE}
ggplot(dat, aes(width, raw_merus)) +
        geom_point(size =2, pch = 1) +
        geom_line(data = confidenceI, aes(width, fit), color = "black", size = 1) +
        #geom_line(data = confidenceI, aes(width, lwr), color = "red", lty = 2, size = 1) +
        #geom_line(data = confidenceI, aes(width, upr), color = "red", lty =2, size = 1) +
        geom_line(data = predictionI, aes(width, lwr), color = "blue", lty = 3, size = 1) +
        geom_line(data = predictionI, aes(width, upr), color = "blue", lty =3, size = 1) +
  xlab("carapace width (mm)") + ylab("merus length (mm)") + ggtitle("carapace width vs raw merus length") +
  geom_vline( xintercept = 177.8, color = "red") + 
  #geom_hline(yintercept = 125, color = "dark grey", size = 0.8) +
  #geom_hline(yintercept = 144, color = "dark grey", size = 0.8) +
  #geom_vline(xintercept = 151, color = "dark grey", size = 0.8) +
  #geom_vline(xintercept = 194, color = "dark grey", size = 0.8) +
  scale_x_continuous() +
  scale_y_continuous() +
  geom_rect(data = dat, mapping = aes(xmin =151, xmax = 194, ymin= 125, ymax = 144), color= "gray52", alpha =0.0005)

```
#### Summary of all data: Mean carapace width and raw merus length
```{r power1, echo=FALSE}
## power analysis ------------
# power analysis to determine sample size needed to predict if legal or not.
# seperate data into legal and non groups
dat %>% 
  mutate(legal = ifelse(width < 178, "N", "Y")) -> dat
#average merus length overall
dat %>% 
  summarise(avg_width = mean(width), avg_merus = mean(raw_merus), 
            width_SD = sd(width), merus_SD = sd(raw_merus))
```

#### Summary by legal status, mean and standard deviations(SD)
```{r legal or not, echo=FALSE}

# average merus length by legal or not
dat %>% 
  group_by(legal) %>% 
  summarise(n = n(), avg_width = mean(width), avg_merus = mean(raw_merus), 
            width_SD = sd(width), merus_SD = sd(raw_merus))

```

\newline
## Power analysis between mean of legal and sublegal?
Conclusion: already a large difference between these two means power analyis for this will NOT help to reduce variablity in the regression and therefore the prediction interval.


## Linear relationship by legal status
```{r linear by group, echo = FALSE}
ggplot(dat, aes(width, raw_merus, colour = legal)) +
         geom_point(size =2) +
         geom_smooth(method =lm)


```
